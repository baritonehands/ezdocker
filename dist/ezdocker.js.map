{"version":3,"sources":["ezdocker.js"],"names":[],"mappings":"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","file":"ezdocker.js","sourcesContent":["import _ from 'lodash';\nimport Docker from 'dockerode';\nimport stream from 'stream';\nimport chalk from 'chalk';\nimport TarUtils from './tar-utils';\n\nclass ImageBuilder {\n\n  constructor(ezdocker) {\n    this._repo = undefined;\n    this._tag = undefined;\n    this._paths = {};\n    this._ezdocker = ezdocker;\n  }\n\n  repository(repo) {\n    this._repo = repo;\n    return this;\n  }\n\n  tag(tag) {\n    this._tag = tag;\n    return this;\n  }\n\n  addPath(src, dest) {\n    this._paths[src] = dest || '.';\n    return this;\n  }\n\n  getFullTag() {\n    return this._repo + ':' + this._tag;\n  }\n\n  build() {\n    return this._ezdocker.buildImage(this);\n  }\n}\n\nclass EZDocker {\n\n  constructor(connectionOpts, docker, tarUtils = new TarUtils()) {\n    this._docker = docker || new Docker(connectionOpts);\n    this._tarUtils = tarUtils;\n  }\n\n  imageBuilder() {\n    return new ImageBuilder(this);\n  }\n\n  buildImage(imageBuilder) {\n    return this._tarUtils.all(imageBuilder._paths)\n      .then((stream) => {\n        return new Promise((resolve, reject) => {\n          this._docker.buildImage(stream, {t: imageBuilder.getFullTag()}, (error, response) => {\n            if (error) {\n              reject(error);\n            } else {\n              response.pipe(stream_parser);\n              response.on('end', () => {\n                resolve();\n              });\n            }\n          });\n        });\n      });\n  }\n\n  removeImages(repository) {\n    return this.listImages(repository)\n      .then((images) => {\n        return Promise.all(_.map(images, (imageInfo) => {\n          return this.removeImage(imageInfo.Id);\n        }));\n      });\n  }\n\n  listImages(repository) {\n    return new Promise((resolve, reject) => {\n      this._docker.listImages({filter: repository}, (error, response) => {\n        if (error) {\n          console.log(chalk.red('(Docker) Listing Docker Images Failed: ' + error.message));\n          reject(error);\n        } else {\n          resolve(response);\n        }\n      });\n    });\n  }\n\n  removeImage(id) {\n    return new Promise((resolve, reject) => {\n      this._docker.getImage(id).remove({}, (error, response) => {\n        if (error) {\n          if (error.statusCode == 404) {\n            console.log(chalk.blue('(Docker) ') + 'No docker images to remove.');\n          } else {\n            console.log(chalk.red('(Docker) Removing Docker Image Failed: ' + error.message));\n            reject(error);\n          }\n        } else {\n          console.log(chalk.blue('(Docker) ') + 'Removing Image ' + id);\n          _.forEach(response, (step) => {\n            _.forEach(step, (target, action) => {\n              console.log(chalk.blue('(Docker)   ') + action + ' ' + target);\n            });\n          });\n          resolve();\n        }\n      });\n    });\n  };\n\n  pushImages(repository) {\n    return new Promise((resolve, reject) => {\n      this._docker.getImage(repository).push({}, (error, response) => {\n        if (error) {\n          console.log(chalk.red('(Docker) Pushing Docker Image(s) Failed: ' + error.message));\n          reject(error);\n        } else {\n          response.pipe(stream_parser);\n          response.on('end', () => { resolve(); });\n        }\n      });\n    });\n  }\n}\n\nconst stream_parser = new stream.Writable({\n  write: function(chunk, encoding, next) {\n    var data = JSON.parse(chunk.toString());\n\n    var msg = '';\n    if (data.stream) {\n      data.stream = data.stream.replace(/\\n$/, '');\n      msg +=  chalk.blue('(Docker) ') + data.stream;\n    } else {\n      msg += chalk.blue('(Docker RAW) ') + JSON.stringify(data);\n    }\n\n    console.log(msg);\n    next();\n  }\n});\n\n/* TODO: Figure out how to do this with a proper ES6 export */\nmodule.exports = EZDocker;"],"sourceRoot":"/source/"}